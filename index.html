<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b1526" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <title>Risk Battle Simulator | War Room Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cinzel:wght@700;800&family=Space+Grotesk:wght@400;500;700&display=swap');

        :root {
            --bg-900: #131620;
            --bg-800: #1e2433;
            --ink-100: #fff7e9;
            --ink-300: #dacdb5;
            --accent-red: #d9483b;
            --accent-red-soft: #ff8f6a;
            --accent-blue: #3f84d8;
            --accent-blue-soft: #8ac8ff;
            --accent-green: #6fae61;
            --accent-gold: #f0c76f;
            --panel: rgba(26, 29, 41, 0.82);
            --panel-border: rgba(240, 199, 111, 0.32);
            --shadow: 0 18px 45px rgba(4, 5, 11, 0.52);
            --radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            color: var(--ink-100);
            background:
                radial-gradient(circle at 18% 14%, rgba(238, 99, 77, 0.36), transparent 34%),
                radial-gradient(circle at 82% 12%, rgba(74, 146, 229, 0.32), transparent 36%),
                radial-gradient(circle at 50% 90%, rgba(111, 174, 97, 0.26), transparent 42%),
                linear-gradient(135deg, #2a221b 0%, #1d2232 42%, #1f2d2f 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -2;
        }

        body::before {
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.06), transparent 60%),
                repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.03) 0 2px, transparent 2px 14px),
                repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 0 2px, transparent 2px 14px);
            background-size: auto, 28px 28px, 28px 28px;
            animation: drift 16s linear infinite;
        }

        body::after {
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0), rgba(7, 6, 4, 0.72));
            z-index: -1;
        }

        @keyframes drift {
            from { transform: translate3d(0, 0, 0); }
            to { transform: translate3d(-26px, -26px, 0); }
        }

        .app {
            width: min(1180px, 94vw);
            margin: 28px auto 40px;
            display: grid;
            gap: 18px;
        }

        .panel {
            border: 1px solid var(--panel-border);
            background: var(--panel);
            backdrop-filter: blur(9px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .header {
            padding: 24px 26px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            align-items: center;
            text-align: center;
            border: 1px solid rgba(240, 199, 111, 0.45);
            background:
                linear-gradient(120deg, rgba(217, 72, 59, 0.18), transparent 30%),
                linear-gradient(240deg, rgba(63, 132, 216, 0.2), transparent 32%),
                rgba(24, 24, 30, 0.9);
        }

        .title-wrap h1 {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 2.6px;
            font-size: clamp(2.2rem, 4.5vw, 4rem);
            line-height: 1;
            background: linear-gradient(180deg, #ffe7aa 0%, #f0c76f 62%, #b78945 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 3px 18px rgba(240, 199, 111, 0.22);
        }

        .brand-logo {
            margin: 10px auto 8px;
            display: flex;
            justify-content: center;
        }

        .logo-emblem {
            width: 70px;
            height: 46px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            background:
                linear-gradient(135deg, rgba(217, 72, 59, 0.26), rgba(63, 132, 216, 0.24)),
                linear-gradient(145deg, rgba(246, 184, 77, 0.24), rgba(13, 18, 29, 0.72));
            box-shadow: inset 0 0 20px rgba(246, 184, 77, 0.17), 0 10px 22px rgba(0, 0, 0, 0.3);
        }

        .logo-emblem::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 8px;
            bottom: 8px;
            width: 1px;
            background: linear-gradient(180deg, transparent, rgba(255, 255, 255, 0.45), transparent);
            transform: translateX(-50%);
        }

        .logo-cube {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.33);
            transform: rotate(-8deg);
            position: absolute;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.34);
        }

        .logo-cube.attack {
            left: 12px;
            top: 12px;
            background: linear-gradient(150deg, #ffb189, #cc4236);
        }

        .logo-cube.defense {
            right: 12px;
            top: 12px;
            background: linear-gradient(150deg, #bce2ff, #4386d8);
            transform: rotate(8deg);
        }

        .logo-dot {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #fff8e7;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2);
        }

        .logo-dot.tl { top: 4px; left: 4px; }
        .logo-dot.tr { top: 4px; right: 4px; }
        .logo-dot.bl { bottom: 4px; left: 4px; }
        .logo-dot.br { bottom: 4px; right: 4px; }
        .logo-dot.c { top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .title-wrap {
            text-align: center;
        }

        .title-wrap p {
            margin-top: 6px;
            color: var(--ink-300);
            font-size: 0.9rem;
            letter-spacing: 0.3px;
        }

        .status-chip {
            border-radius: 999px;
            padding: 8px 18px;
            border: 1px solid rgba(240, 199, 111, 0.45);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #fff3d5;
            background: linear-gradient(130deg, rgba(217, 72, 59, 0.42), rgba(63, 132, 216, 0.36));
            white-space: nowrap;
        }

        .support-fab {
            position: fixed;
            top: max(10px, calc(env(safe-area-inset-top) + 6px));
            right: max(10px, calc(env(safe-area-inset-right) + 6px));
            width: 44px;
            height: 44px;
            min-height: 44px;
            padding: 0;
            border-radius: 999px;
            border: 1px solid rgba(240, 199, 111, 0.6);
            background: linear-gradient(145deg, rgba(240, 199, 111, 0.95), rgba(217, 72, 59, 0.9));
            color: #1b1609;
            font-size: 1.15rem;
            font-weight: 700;
            line-height: 1;
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.38);
            display: grid;
            place-items: center;
            z-index: 70;
        }

        .support-fab:hover {
            transform: translateY(-1px) scale(1.04);
            filter: brightness(1.05);
        }

        .support-fab:active {
            transform: scale(0.96);
        }

        .support-modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 80;
        }

        body.support-open .support-modal {
            display: block;
        }

        .support-modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(5, 9, 16, 0.72);
            backdrop-filter: blur(4px);
        }

        body.battle-mode .support-fab,
        body.battle-mode .support-modal {
            display: none !important;
        }

        .support-dialog {
            position: absolute;
            top: max(60px, calc(env(safe-area-inset-top) + 42px));
            right: max(10px, calc(env(safe-area-inset-right) + 6px));
            width: min(320px, calc(100vw - 20px));
            border-radius: 16px;
            border: 1px solid rgba(240, 199, 111, 0.45);
            background:
                linear-gradient(140deg, rgba(217, 72, 59, 0.18), rgba(63, 132, 216, 0.12)),
                rgba(17, 22, 33, 0.96);
            box-shadow: 0 18px 48px rgba(0, 0, 0, 0.48);
            padding: 12px;
            display: grid;
            gap: 10px;
        }

        .support-dialog-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .support-dialog-title {
            font-size: 0.78rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #f5e3bc;
        }

        .support-close {
            width: 30px;
            height: 30px;
            min-height: 30px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            font-size: 0.95rem;
            padding: 0;
            box-shadow: none;
        }

        .support-dialog-copy {
            color: #e9ddc5;
            font-size: 0.82rem;
            line-height: 1.3;
        }

        .support-dialog-links {
            display: grid;
            gap: 8px;
        }

        .support-dialog-links .support-link {
            justify-content: flex-start;
            width: 100%;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        .control-card {
            padding: 18px;
        }

        .control-card h2 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1.4px;
            color: var(--ink-300);
        }

        .control-card strong {
            display: block;
            margin-top: 8px;
            font-size: clamp(2rem, 4vw, 3rem);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            line-height: 1;
        }

        .army-stepper {
            margin-top: 14px;
            width: 100%;
            display: grid;
            grid-template-columns: minmax(0, 1fr) 42px;
            border: 1px solid rgba(255, 255, 255, 0.22);
            border-radius: 14px;
            background: rgba(18, 20, 30, 0.85);
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .army-stepper:focus-within {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(240, 199, 111, 0.22);
        }

        .army-stepper.disabled {
            opacity: 0.56;
        }

        .army-stepper input {
            width: 100%;
            border: none;
            border-radius: 0;
            background: transparent;
            padding: 10px 14px;
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff3d5;
            outline: none;
            font-variant-numeric: tabular-nums;
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .army-stepper input::-webkit-outer-spin-button,
        .army-stepper input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .stepper-rail {
            display: grid;
            grid-template-rows: 1fr 1fr;
            border-left: 1px solid rgba(255, 255, 255, 0.16);
            background: linear-gradient(180deg, rgba(240, 199, 111, 0.13), rgba(217, 72, 59, 0.14));
        }

        .stepper-btn {
            border: none;
            background: transparent;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: background-color 0.18s ease, transform 0.14s ease, opacity 0.18s ease;
        }

        .stepper-btn + .stepper-btn {
            border-top: 1px solid rgba(255, 255, 255, 0.14);
        }

        .stepper-btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .stepper-btn:active {
            transform: scale(0.95);
        }

        .stepper-btn:disabled {
            cursor: not-allowed;
            opacity: 0.45;
        }

        .stepper-btn::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.35));
        }

        .stepper-btn.up::before {
            border-bottom: 9px solid #ffe6a1;
        }

        .stepper-btn.down::before {
            border-top: 9px solid #ffe6a1;
        }

        .mobile-wheel-picker {
            display: none;
            margin-top: 12px;
            position: relative;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: linear-gradient(180deg, rgba(9, 17, 31, 0.95), rgba(7, 13, 25, 0.95));
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
        }

        .mobile-wheel-picker::before,
        .mobile-wheel-picker::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 56px;
            pointer-events: none;
            z-index: 3;
        }

        .mobile-wheel-picker::before {
            top: 0;
            background: linear-gradient(180deg, rgba(7, 13, 25, 0.96), rgba(7, 13, 25, 0));
        }

        .mobile-wheel-picker::after {
            bottom: 0;
            background: linear-gradient(0deg, rgba(7, 13, 25, 0.96), rgba(7, 13, 25, 0));
        }

        .wheel-focus-line {
            position: absolute;
            left: 8px;
            right: 8px;
            top: calc(50% - 22px);
            height: 44px;
            border-radius: 10px;
            border-top: 1px solid rgba(246, 184, 77, 0.75);
            border-bottom: 1px solid rgba(246, 184, 77, 0.75);
            background: rgba(246, 184, 77, 0.08);
            box-shadow: 0 0 18px rgba(246, 184, 77, 0.2);
            pointer-events: none;
            z-index: 2;
        }

        .army-wheel {
            height: 172px;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            padding: var(--wheel-edge-padding, 64px) 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            overscroll-behavior: contain;
            position: relative;
            z-index: 1;
            -webkit-overflow-scrolling: touch;
        }

        .army-wheel::-webkit-scrollbar {
            display: none;
        }

        .wheel-item {
            height: 44px;
            scroll-snap-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
            font-size: 1.7rem;
            color: rgba(196, 210, 239, 0.38);
            transition: transform 0.18s ease, color 0.18s ease, text-shadow 0.18s ease;
            user-select: none;
        }

        .wheel-item.near {
            color: rgba(226, 236, 255, 0.78);
        }

        .wheel-item.active {
            color: #fff8df;
            transform: scale(1.12);
            text-shadow: 0 0 18px rgba(246, 184, 77, 0.5);
        }

        .mobile-wheel-picker.disabled {
            opacity: 0.48;
            filter: grayscale(0.25);
        }

        .mobile-wheel-picker.disabled .army-wheel {
            pointer-events: none;
        }

        .control-card.attack {
            border: 1px solid rgba(217, 72, 59, 0.56);
            background: linear-gradient(150deg, rgba(217, 72, 59, 0.34), rgba(34, 20, 20, 0.86));
        }

        .control-card.defense {
            border: 1px solid rgba(63, 132, 216, 0.56);
            background: linear-gradient(150deg, rgba(63, 132, 216, 0.35), rgba(18, 29, 38, 0.86));
        }

        .control-card.meta {
            display: grid;
            gap: 14px;
            align-content: center;
            background: linear-gradient(150deg, rgba(111, 174, 97, 0.3), rgba(22, 28, 20, 0.88));
            border: 1px solid rgba(111, 174, 97, 0.5);
        }

        .setup-action {
            margin-top: 2px;
        }

        .support-strip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            background:
                linear-gradient(120deg, rgba(240, 199, 111, 0.22), transparent 32%),
                rgba(25, 23, 24, 0.88);
        }

        .support-copy {
            color: #f4e4c1;
            font-size: 0.86rem;
        }

        .support-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .support-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(240, 199, 111, 0.36);
            padding: 8px 10px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.2px;
            text-decoration: none;
            color: #fff;
            transition: transform 0.16s ease, filter 0.16s ease, border-color 0.2s ease;
        }

        .support-link:hover {
            transform: translateY(-1px);
            filter: brightness(1.06);
            border-color: rgba(246, 184, 77, 0.75);
        }

        .support-link.github {
            background: linear-gradient(140deg, #4d5e77, #2a3248);
        }

        .support-link.coffee {
            background: linear-gradient(140deg, #ffe489, #f2b141);
            color: #221a07;
        }

        .battlefield {
            position: relative;
            padding: 24px;
            overflow: hidden;
            isolation: isolate;
        }

        .battlefield::before {
            content: '';
            position: absolute;
            inset: -18% 10% auto;
            height: 150px;
            background: radial-gradient(circle, rgba(240, 199, 111, 0.16), transparent 70%);
            z-index: -1;
        }

        .battle-stage {
            position: relative;
            display: grid;
            grid-template-columns: minmax(220px, 1fr) minmax(280px, 440px) minmax(220px, 1fr);
            gap: 14px;
            align-items: stretch;
            margin-bottom: 16px;
        }

        .battle-stage::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 12px;
            bottom: 12px;
            width: 1px;
            background: linear-gradient(180deg, transparent, rgba(240, 199, 111, 0.34), transparent);
            transform: translateX(-50%);
            pointer-events: none;
        }

        .round-indicator {
            text-align: center;
            white-space: nowrap;
            margin-bottom: 8px;
        }

        .round-indicator span {
            display: block;
            text-transform: uppercase;
            letter-spacing: 1.1px;
            font-size: 0.72rem;
            color: #e6d4af;
        }

        .round-indicator b {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 400;
            color: #ffe8b0;
        }

        .flank {
            border-radius: 14px;
            border: 1px solid rgba(240, 199, 111, 0.22);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 236px;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
        }

        .flank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .flank-label {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.78rem;
            color: var(--ink-300);
        }

        .flank-count {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2rem, 5vw, 3rem);
            line-height: 1;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .flank-meta {
            font-size: 0.82rem;
            color: #fff;
            font-weight: 600;
        }

        .flank.attack {
            background: linear-gradient(165deg, rgba(217, 72, 59, 0.36), rgba(41, 21, 21, 0.85));
            border-color: rgba(217, 72, 59, 0.46);
            transform: perspective(760px) rotateY(7deg);
        }

        .flank.attack .flank-count {
            color: #ffd3bf;
        }

        .flank.defense {
            background: linear-gradient(165deg, rgba(63, 132, 216, 0.36), rgba(17, 30, 42, 0.88));
            border-color: rgba(63, 132, 216, 0.46);
            transform: perspective(760px) rotateY(-7deg);
        }

        .flank.defense .flank-count {
            color: #d7eeff;
        }

        .flank-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .flank-arrow {
            text-transform: uppercase;
            font-size: 0.72rem;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.65);
        }

        .center-core {
            border-radius: 14px;
            border: 1px solid rgba(240, 199, 111, 0.3);
            padding: 12px;
            background: linear-gradient(180deg, rgba(240, 199, 111, 0.2), rgba(31, 27, 20, 0.88));
            box-shadow: inset 0 0 0 1px rgba(240, 199, 111, 0.18);
        }

        .army-canvas {
            min-height: 156px;
            border-radius: 10px;
            border: 1px dashed rgba(240, 199, 111, 0.32);
            background: rgba(10, 11, 17, 0.48);
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 16px);
            gap: 6px;
            align-content: flex-start;
        }

        .attack-canvas {
            justify-content: end;
        }

        .defense-canvas {
            justify-content: start;
        }

        .army-unit {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.24);
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
            transition: transform 0.18s ease;
        }

        .army-unit::before,
        .army-unit::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.78);
        }

        .army-unit::before {
            top: 2px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .army-unit::after {
            top: 7px;
            width: 7px;
            height: 6px;
            border-radius: 3px;
        }

        .army-unit.attack {
            background: linear-gradient(150deg, #ffbf9c, #d9483b);
        }

        .army-unit.defense {
            background: linear-gradient(150deg, #c5e8ff, #3f84d8);
        }

        .army-unit.casualty {
            z-index: 2;
        }

        .army-unit.casualty.attack {
            animation: unitDownLeft 0.32s ease forwards;
        }

        .army-unit.casualty.defense {
            animation: unitDownRight 0.32s ease forwards;
        }

        @keyframes unitDownLeft {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translate(-14px, 10px) rotate(-24deg) scale(0.38); opacity: 0; }
        }

        @keyframes unitDownRight {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translate(14px, 10px) rotate(24deg) scale(0.38); opacity: 0; }
        }

        .army-more {
            min-width: 34px;
            height: 14px;
            padding: 0 4px;
            border-radius: 7px;
            display: grid;
            place-items: center;
            font-size: 0.64rem;
            font-weight: 700;
            color: var(--ink-100);
            border: 1px solid rgba(255, 255, 255, 0.24);
            background: rgba(255, 255, 255, 0.08);
            align-self: center;
        }

        .army-more.attack {
            justify-self: end;
        }

        .army-more.defense {
            justify-self: start;
        }

        .army-empty {
            grid-column: 1 / -1;
            align-self: center;
            justify-self: center;
            font-size: 0.72rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(255, 231, 176, 0.75);
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid rgba(240, 199, 111, 0.3);
            background: rgba(240, 199, 111, 0.1);
        }

        .dice-arena {
            position: relative;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            min-height: 190px;
            padding: 14px 8px;
            border-radius: 16px;
            background: linear-gradient(90deg, rgba(217, 72, 59, 0.24), rgba(43, 33, 25, 0.72) 46%, rgba(63, 132, 216, 0.24));
            border: 1px solid rgba(240, 199, 111, 0.26);
        }

        .tray {
            min-height: 146px;
            border-radius: 14px;
            border: 1px dashed rgba(240, 199, 111, 0.36);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(56px, 1fr));
            align-content: center;
            align-items: center;
            justify-items: center;
            gap: 10px;
            padding: 10px;
            position: relative;
        }

        .tray::before {
            content: attr(data-side);
            position: absolute;
            top: 6px;
            left: 8px;
            font-size: 0.62rem;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.55);
            text-transform: uppercase;
        }

        .tray.attack {
            background: rgba(217, 72, 59, 0.18);
        }

        .tray.defense {
            background: rgba(63, 132, 216, 0.18);
        }

        .vs {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.3rem;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.24);
            user-select: none;
        }

        .die {
            width: 64px;
            height: 64px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: grid;
            place-items: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 1px;
            color: #fff;
            position: relative;
            transform-origin: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.38);
        }

        .die.attack { background: linear-gradient(160deg, #ff6a6d, #ac1c2b); }
        .die.defense { background: linear-gradient(160deg, #95d1ff, #2f66ac); }

        .die.rolling {
            animation: tumble 0.22s linear infinite;
        }

        .die.win {
            outline: 2px solid rgba(246, 184, 77, 0.94);
            box-shadow: 0 0 0 3px rgba(246, 184, 77, 0.2), 0 16px 26px rgba(246, 184, 77, 0.26);
            transform: translateY(-4px) scale(1.06);
        }

        .die.lose {
            filter: grayscale(0.35) brightness(0.8);
            transform: translateY(3px) scale(0.94);
            opacity: 0.8;
        }

        @keyframes tumble {
            0% { transform: rotate(0deg) scale(0.95); }
            25% { transform: rotate(80deg) scale(1.05); }
            50% { transform: rotate(150deg) scale(0.98); }
            75% { transform: rotate(230deg) scale(1.02); }
            100% { transform: rotate(320deg) scale(0.95); }
        }

        .impact-flash {
            position: absolute;
            inset: 0;
            border-radius: 16px;
            pointer-events: none;
            opacity: 0;
            background: radial-gradient(circle, rgba(246, 184, 77, 0.38) 0%, rgba(246, 184, 77, 0.02) 58%, transparent 80%);
        }

        .impact-flash.active {
            animation: flash 0.45s ease-out;
        }

        @keyframes flash {
            0% { opacity: 0.05; }
            40% { opacity: 1; }
            100% { opacity: 0; }
        }

        .battlefield.shake {
            animation: quake 0.34s linear;
        }

        @keyframes quake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(4px); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
            100% { transform: translateX(0); }
        }

        .loss-grid {
            margin-top: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .loss-box {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--ink-300);
        }

        .loss-box b {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            line-height: 1;
            font-weight: 400;
            color: #fff;
        }

        .loss-box.attack { background: rgba(255, 77, 79, 0.12); }
        .loss-box.defense { background: rgba(63, 132, 216, 0.14); }

        .pulse {
            animation: pulseLoss 0.5s ease;
        }

        @keyframes pulseLoss {
            0% { transform: scale(1); }
            35% { transform: scale(1.16); }
            100% { transform: scale(1); }
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            margin-top: 18px;
        }

        button {
            border: 0;
            border-radius: 12px;
            padding: 12px 14px;
            font-weight: 700;
            letter-spacing: 0.4px;
            cursor: pointer;
            color: #fff;
            transition: transform 0.16s ease, filter 0.16s ease, opacity 0.2s ease;
            min-height: 46px;
        }

        button:active {
            transform: translateY(1px) scale(0.98);
        }

        button:disabled {
            opacity: 0.42;
            cursor: not-allowed;
            transform: none;
            filter: grayscale(0.3);
        }

        .btn-attack {
            background: linear-gradient(140deg, #f07156, #ba372e);
            box-shadow: 0 10px 24px rgba(186, 55, 46, 0.38);
        }

        .btn-allin {
            background: linear-gradient(140deg, #f2d576, #e9a63f);
            box-shadow: 0 10px 24px rgba(233, 166, 63, 0.34);
            color: #1c1508;
        }

        .btn-reset {
            background: linear-gradient(140deg, #89a7cc, #4b5f7a);
            box-shadow: 0 10px 24px rgba(75, 95, 122, 0.38);
        }

        .btn-log {
            background: linear-gradient(140deg, #7d8bd1, #4b58a6);
            box-shadow: 0 10px 24px rgba(75, 88, 166, 0.34);
        }

        .btn-start {
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(244, 206, 123, 0.65);
            background:
                linear-gradient(165deg, rgba(255, 210, 122, 0.32), rgba(255, 210, 122, 0) 42%),
                linear-gradient(145deg, #ca4338, #8e2226 62%, #c86c3c);
            box-shadow:
                inset 0 1px 0 rgba(255, 232, 173, 0.55),
                inset 0 -1px 0 rgba(81, 13, 17, 0.58),
                0 12px 26px rgba(142, 34, 38, 0.48);
            color: #fff3dc;
            text-transform: uppercase;
            letter-spacing: 1.05px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .btn-start::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, transparent 0%, rgba(255, 242, 203, 0.22) 48%, transparent 100%);
            transform: translateX(-130%);
            transition: transform 0.45s ease;
        }

        .btn-start:hover::after {
            transform: translateX(130%);
        }

        .btn-start .start-icon {
            font-size: 1rem;
            margin-right: 6px;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.5));
            position: relative;
            z-index: 1;
        }

        .btn-start .start-text {
            position: relative;
            z-index: 1;
        }

        .mobile-only {
            display: none;
        }

        .banner {
            padding: 16px 18px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.22);
            font-size: 1rem;
            margin-top: 16px;
            display: none;
        }

        .banner b {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 1px;
            font-weight: 400;
            vertical-align: middle;
            margin-right: 8px;
        }

        .banner.attacker {
            display: block;
            background: linear-gradient(120deg, rgba(255, 77, 79, 0.18), rgba(255, 77, 79, 0.05));
            border-color: rgba(255, 77, 79, 0.45);
        }

        .banner.defender {
            display: block;
            background: linear-gradient(120deg, rgba(84, 164, 255, 0.18), rgba(84, 164, 255, 0.05));
            border-color: rgba(84, 164, 255, 0.45);
        }

        .log {
            padding: 20px;
        }

        .log h3 {
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--ink-300);
            font-size: 0.88rem;
            margin-bottom: 12px;
        }

        .log-list {
            list-style: none;
            display: grid;
            gap: 10px;
            max-height: 340px;
            overflow-y: auto;
            padding-right: 6px;
            scrollbar-width: thin;
            scrollbar-color: rgba(240, 199, 111, 0.86) rgba(12, 18, 31, 0.82);
        }

        .log-list::-webkit-scrollbar {
            width: 10px;
        }

        .log-list::-webkit-scrollbar-track {
            background: rgba(10, 16, 28, 0.82);
            border-radius: 999px;
        }

        .log-list::-webkit-scrollbar-thumb {
            border-radius: 999px;
            background: linear-gradient(180deg, #f0c76f, #d9483b);
            border: 2px solid rgba(10, 16, 28, 0.82);
        }

        .log-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ffe3a0, #f16252);
        }

        .log-item {
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            background: rgba(7, 13, 24, 0.75);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            align-items: center;
            animation: fadeIn 0.35s ease;
        }

        .log-round {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            color: var(--ink-300);
            min-width: 42px;
        }

        .log-dice {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--ink-100);
        }

        .log-loss {
            text-align: right;
            font-size: 0.85rem;
            color: var(--ink-300);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 980px) {
            html,
            body {
                min-height: 100dvh;
                height: 100dvh;
            }

            body {
                overflow-x: hidden;
                overflow: hidden;
                overscroll-behavior: none;
            }

            .app {
                width: 100vw;
                height: 100dvh;
                min-height: 100dvh;
                margin: 0;
                padding: 8px 8px max(8px, env(safe-area-inset-bottom));
                gap: 8px;
                overflow: hidden;
            }

            body:not(.battle-mode) .app {
                grid-template-rows: auto minmax(0, 1fr);
            }

            .header {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                padding: 10px;
                text-align: center;
            }

            .title-wrap h1 {
                font-size: clamp(1.28rem, 6.4vw, 1.9rem);
            }

            .brand-logo {
                margin-top: 4px;
                margin-bottom: 2px;
            }

            .logo-emblem {
                width: 46px;
                height: 32px;
            }

            .logo-cube {
                width: 14px;
                height: 14px;
                border-radius: 4px;
            }

            .logo-cube.attack {
                left: 7px;
                top: 8px;
            }

            .logo-cube.defense {
                right: 7px;
                top: 8px;
            }

            .logo-dot {
                width: 3px;
                height: 3px;
            }

            .logo-dot.tl { top: 3px; left: 3px; }
            .logo-dot.tr { top: 3px; right: 3px; }
            .logo-dot.bl { bottom: 3px; left: 3px; }
            .logo-dot.br { bottom: 3px; right: 3px; }

            .title-wrap p {
                display: none;
            }

            .status-chip {
                display: none;
            }

            .control-grid {
                height: 100%;
                min-height: 0;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: minmax(0, 1fr) auto;
                grid-auto-rows: auto;
                gap: 8px;
            }

            .control-card {
                padding: 8px;
                min-height: 0;
            }

            .control-card.attack,
            .control-card.defense {
                display: grid;
                grid-template-rows: auto minmax(0, 1fr);
                gap: 6px;
            }

            .control-card strong {
                margin-top: 4px;
                font-size: 1.6rem;
            }

            .control-card input {
                font-size: 1.1rem;
                padding: 8px 10px;
                display: none;
            }

            .army-stepper {
                display: none;
            }

            .mobile-wheel-picker {
                display: block;
                margin-top: 0;
                height: 100%;
                min-height: 0;
            }

            .setup-action {
                margin-top: 0;
                min-height: 48px;
                width: 100%;
            }

            .army-wheel {
                height: 100%;
                min-height: 0;
                padding: var(--wheel-edge-padding, 44px) 6px;
            }

            .control-card.meta {
                grid-column: 1 / -1;
                min-height: auto;
                padding: 6px;
                align-content: stretch;
            }

            .support-strip {
                display: none;
            }

            body:not(.battle-mode) #battlefield,
            body:not(.battle-mode) #battleLogPanel {
                display: none;
            }

            body.battle-mode .header,
            body.battle-mode .control-grid,
            body.battle-mode #battleLogPanel {
                display: none;
            }

            body.battle-mode .app {
                height: 100dvh;
                padding: 0;
                gap: 0;
                overflow: hidden;
            }

            body.battle-mode #battlefield {
                height: 100dvh;
                min-height: 100dvh;
                border-radius: 0;
                border: none;
                box-shadow: none;
                padding: 8px 8px calc(8px + env(safe-area-inset-bottom));
                display: grid;
                grid-template-rows: 1fr auto;
                gap: 8px;
                overflow: hidden;
            }

            body.battle-mode #battlefield::before {
                opacity: 0.5;
            }

            body.battle-mode .battle-stage {
                margin-bottom: 0;
                min-height: 0;
                height: 100%;
                grid-template-columns: 1fr;
                grid-template-rows: minmax(0, 1fr) auto minmax(0, 1fr);
                gap: 8px;
            }

            body.battle-mode .battle-stage::before {
                display: none;
            }

            body.battle-mode .center-core {
                order: 2;
                grid-column: auto;
                padding: 8px;
                min-height: 0;
                display: grid;
                grid-template-rows: auto 1fr;
                gap: 6px;
            }

            body.battle-mode .flank.defense {
                order: 1;
            }

            body.battle-mode .flank.attack {
                order: 3;
            }

            body.battle-mode .round-indicator {
                margin-bottom: 0;
            }

            body.battle-mode .round-indicator b {
                font-size: 1.5rem;
            }

            body.battle-mode .dice-arena {
                grid-template-columns: 1fr auto 1fr;
                gap: 6px;
                min-height: 0;
                height: 100%;
                padding: 8px 6px;
            }

            body.battle-mode .tray {
                min-height: 84px;
                padding: 18px 6px 6px;
                gap: 6px;
                grid-template-columns: repeat(3, minmax(32px, 1fr));
            }

            body.battle-mode .tray::before {
                top: 4px;
                left: 6px;
                font-size: 0.56rem;
            }

            body.battle-mode .die {
                width: 38px;
                height: 38px;
                border-radius: 10px;
                font-size: 1.4rem;
            }

            body.battle-mode .vs {
                font-size: 1.8rem;
            }

            body.battle-mode .flank {
                transform: none;
                min-height: 0;
                padding: 8px;
                gap: 6px;
            }

            body.battle-mode .flank-label {
                font-size: 0.62rem;
            }

            body.battle-mode .flank-count {
                font-size: 1.7rem;
            }

            body.battle-mode .flank-meta {
                font-size: 0.68rem;
            }

            body.battle-mode .flank-arrow {
                display: none;
            }

            body.battle-mode .army-canvas {
                min-height: 0;
                height: 100%;
                padding: 5px;
                gap: 4px;
                overflow: hidden;
                grid-template-columns: repeat(auto-fill, 12px);
            }

            body.battle-mode .army-unit {
                width: 12px;
                height: 12px;
                border-radius: 3px;
            }

            body.battle-mode .army-unit::before {
                top: 1px;
                width: 4px;
                height: 4px;
            }

            body.battle-mode .army-unit::after {
                top: 5px;
                width: 5px;
                height: 4px;
            }

            body.battle-mode .army-more {
                min-width: 26px;
                height: 12px;
                font-size: 0.54rem;
            }

            body.battle-mode .loss-grid {
                display: none;
            }

            body.battle-mode .actions {
                position: static;
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 6px;
                margin-top: 0;
                padding: 0;
                background: transparent;
                border: none;
                backdrop-filter: none;
            }

            body.battle-mode .actions button {
                min-height: 40px;
                font-size: 0.72rem;
                padding: 8px 4px;
            }

            body.battle-mode .mobile-only {
                display: block;
            }

            body.battle-mode #battleLogPanel {
                display: none !important;
            }

            body.battle-mode.log-open #battleLogPanel {
                display: block !important;
                position: fixed;
                inset: max(8px, env(safe-area-inset-top)) 8px calc(62px + env(safe-area-inset-bottom)) 8px;
                z-index: 60;
                margin: 0;
                padding: 12px;
                border-radius: 14px;
                background: rgba(8, 14, 25, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.22);
            }

            body.battle-mode.log-open #battleLogPanel .log-list {
                max-height: 100%;
                height: calc(100% - 30px);
            }

            body.battle-mode.log-open .battle-stage {
                opacity: 0.22;
                pointer-events: none;
            }
        }
    </style>
</head>
<body>
    <main class="app">
        <section class="panel header">
            <div class="title-wrap">
                <div class="brand-logo" aria-hidden="true">
                    <span class="logo-emblem">
                        <span class="logo-cube attack">
                            <span class="logo-dot tl"></span>
                            <span class="logo-dot c"></span>
                            <span class="logo-dot br"></span>
                        </span>
                        <span class="logo-cube defense">
                            <span class="logo-dot tr"></span>
                            <span class="logo-dot bl"></span>
                        </span>
                    </span>
                </div>
                <h1>RISK Dice Battle Simulator</h1>
                <p>Official RISK dice rules, colorful war-table vibe, fast mobile-ready battles.</p>
            </div>
            <div id="statusChip" class="status-chip">Ready For Battle</div>
        </section>

        <section class="control-grid">
            <div class="panel control-card attack">
                <h2>Attacker Setup</h2>
                <div class="army-stepper" data-side="attack">
                    <input id="attackArmies" type="number" min="2" max="100" value="10" />
                    <div class="stepper-rail">
                        <button type="button" class="stepper-btn up" data-side="attack" data-step="1" aria-label="Increase attacker armies"></button>
                        <button type="button" class="stepper-btn down" data-side="attack" data-step="-1" aria-label="Decrease attacker armies"></button>
                    </div>
                </div>
                <div id="attackWheelPicker" class="mobile-wheel-picker">
                    <div class="wheel-focus-line"></div>
                    <div id="attackWheel" class="army-wheel" role="listbox" aria-label="Attacker armies picker"></div>
                </div>
            </div>

            <div class="panel control-card defense">
                <h2>Defender Setup</h2>
                <div class="army-stepper" data-side="defense">
                    <input id="defenseArmies" type="number" min="1" max="100" value="10" />
                    <div class="stepper-rail">
                        <button type="button" class="stepper-btn up" data-side="defense" data-step="1" aria-label="Increase defender armies"></button>
                        <button type="button" class="stepper-btn down" data-side="defense" data-step="-1" aria-label="Decrease defender armies"></button>
                    </div>
                </div>
                <div id="defenseWheelPicker" class="mobile-wheel-picker">
                    <div class="wheel-focus-line"></div>
                    <div id="defenseWheel" class="army-wheel" role="listbox" aria-label="Defender armies picker"></div>
                </div>
            </div>

            <div class="panel control-card meta">
                <button id="startBattleBtn" class="btn-start setup-action">
                    <span class="start-icon">âš”</span>
                    <span class="start-text">Launch Battle</span>
                </button>
            </div>
        </section>

        <section id="battlefield" class="panel battlefield">
            <div class="battle-stage">
                <article class="flank attack">
                    <header class="flank-header">
                        <h4 class="flank-label">Attacker Line</h4>
                        <span id="arenaAttackArmies" class="flank-count">10</span>
                    </header>
                    <div class="flank-meta-row">
                        <span id="attackVisualLabel" class="flank-meta">10 units</span>
                        <span class="flank-arrow">Advance â†’</span>
                    </div>
                    <div id="attackArmyVisual" class="army-canvas attack-canvas"></div>
                </article>

                <div class="center-core">
                    <div class="round-indicator">
                        <span>Current Round</span>
                        <b id="roundNumber">0</b>
                    </div>
                    <div class="dice-arena">
                        <div id="attackTray" class="tray attack" data-side="Attack Dice"></div>
                        <div class="vs">VS</div>
                        <div id="defenseTray" class="tray defense" data-side="Defense Dice"></div>
                        <div id="impactFlash" class="impact-flash"></div>
                    </div>
                </div>

                <article class="flank defense">
                    <header class="flank-header">
                        <h4 class="flank-label">Defender Line</h4>
                        <span id="arenaDefenseArmies" class="flank-count">10</span>
                    </header>
                    <div class="flank-meta-row">
                        <span class="flank-arrow">â† Hold Line</span>
                        <span id="defenseVisualLabel" class="flank-meta">10 units</span>
                    </div>
                    <div id="defenseArmyVisual" class="army-canvas defense-canvas"></div>
                </article>
            </div>

            <div class="loss-grid">
                <div class="loss-box attack">
                    <span>Attack Losses This Round</span>
                    <b id="roundAttackLoss">0</b>
                </div>
                <div class="loss-box defense">
                    <span>Defense Losses This Round</span>
                    <b id="roundDefenseLoss">0</b>
                </div>
            </div>

            <div class="actions">
                <button id="attackBtn" class="btn-attack">Attack Once</button>
                <button id="attackToDeathBtn" class="btn-allin">Attack Until Death</button>
                <button id="resetBtn" class="btn-reset">Reset Campaign</button>
                <button id="toggleLogBtn" class="btn-log mobile-only">Battle Log</button>
            </div>
        </section>

        <section id="battleLogPanel" class="panel log" style="display: none;">
            <h3 id="battleLogTitle">Battle Log</h3>
            <ul id="battleLog" class="log-list"></ul>
        </section>
    </main>

    <button id="supportFab" class="support-fab" type="button" aria-label="Open support options" aria-controls="supportModal" aria-expanded="false">â˜•</button>
    <div id="supportModal" class="support-modal" aria-hidden="true">
        <div id="supportModalBackdrop" class="support-modal-backdrop"></div>
        <section class="support-dialog" role="dialog" aria-modal="true" aria-labelledby="supportModalTitle">
            <header class="support-dialog-header">
                <h3 id="supportModalTitle" class="support-dialog-title">Support This Project</h3>
                <button id="supportModalClose" class="support-close" type="button" aria-label="Close support popup">âœ•</button>
            </header>
            <p class="support-dialog-copy">If this simulator helps you, a star or a coffee means a lot.</p>
            <div class="support-dialog-links">
                <a class="support-link github" href="https://github.com/moorada/RiskBattleSimulator" target="_blank" rel="noopener noreferrer">â­ Leave a star on GitHub</a>
                <a class="support-link coffee" href="https://www.buymeacoffee.com/moorada" target="_blank" rel="noopener noreferrer">â˜• Buy me a coffee</a>
            </div>
        </section>
    </div>

    <script>
        const MAX_ARMY_UNITS = 60;
        const MOBILE_BATTLE_MAX_UNITS = 24;
        const MAX_ARMIES = 100;
        const WHEEL_ITEM_HEIGHT = 44;
        const AudioCtx = window.AudioContext || window.webkitAudioContext;

        const state = {
            attackArmies: 10,
            defenseArmies: 10,
            battleLog: [],
            battleStarted: false,
            logOpen: false,
            gameOver: false,
            autoMode: false,
            isAnimating: false,
            round: 0,
            sessionToken: 0
        };

        const elements = {
            attackInput: document.getElementById('attackArmies'),
            defenseInput: document.getElementById('defenseArmies'),
            attackStepper: document.querySelector('.army-stepper[data-side="attack"]'),
            defenseStepper: document.querySelector('.army-stepper[data-side="defense"]'),
            attackWheelPicker: document.getElementById('attackWheelPicker'),
            defenseWheelPicker: document.getElementById('defenseWheelPicker'),
            attackWheel: document.getElementById('attackWheel'),
            defenseWheel: document.getElementById('defenseWheel'),
            startBattleBtn: document.getElementById('startBattleBtn'),
            attackBtn: document.getElementById('attackBtn'),
            attackToDeathBtn: document.getElementById('attackToDeathBtn'),
            resetBtn: document.getElementById('resetBtn'),
            toggleLogBtn: document.getElementById('toggleLogBtn'),
            statusChip: document.getElementById('statusChip'),
            arenaAttackArmies: document.getElementById('arenaAttackArmies'),
            arenaDefenseArmies: document.getElementById('arenaDefenseArmies'),
            roundNumber: document.getElementById('roundNumber'),
            roundAttackLoss: document.getElementById('roundAttackLoss'),
            roundDefenseLoss: document.getElementById('roundDefenseLoss'),
            battlefield: document.getElementById('battlefield'),
            impactFlash: document.getElementById('impactFlash'),
            attackTray: document.getElementById('attackTray'),
            defenseTray: document.getElementById('defenseTray'),
            attackArmyVisual: document.getElementById('attackArmyVisual'),
            defenseArmyVisual: document.getElementById('defenseArmyVisual'),
            attackVisualLabel: document.getElementById('attackVisualLabel'),
            defenseVisualLabel: document.getElementById('defenseVisualLabel'),
            supportFab: document.getElementById('supportFab'),
            supportModal: document.getElementById('supportModal'),
            supportModalBackdrop: document.getElementById('supportModalBackdrop'),
            supportModalClose: document.getElementById('supportModalClose'),
            battleLogPanel: document.getElementById('battleLogPanel'),
            battleLogTitle: document.getElementById('battleLogTitle'),
            battleLog: document.getElementById('battleLog')
        };

        const stepperButtons = [...document.querySelectorAll('.stepper-btn')];
        const wheelControllers = {};
        let audioContext = null;
        let audioUnlocked = false;

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function ensureAudioContext() {
            if (!AudioCtx) return null;
            if (!audioContext) {
                audioContext = new AudioCtx();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(() => {});
            }
            return audioContext;
        }

        function unlockAudio() {
            const ctx = ensureAudioContext();
            if (!ctx) return;

            if (!audioUnlocked) {
                const now = ctx.currentTime;
                const source = ctx.createBufferSource();
                source.buffer = ctx.createBuffer(1, 1, 22050);
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.0001, now);
                source.connect(gain);
                gain.connect(ctx.destination);
                source.start(now);
                source.stop(now + 0.01);
                audioUnlocked = true;
            }
        }

        function playTone(ctx, frequency, startOffset, duration, type, volume, slideTo = null) {
            const now = ctx.currentTime + startOffset;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(frequency, now);
            if (slideTo !== null) {
                osc.frequency.linearRampToValueAtTime(slideTo, now + duration);
            }

            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.exponentialRampToValueAtTime(volume, now + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(now);
            osc.stop(now + duration + 0.02);
        }

        function playAttackOutcomeSound(attackLosses, defenseLosses) {
            const ctx = ensureAudioContext();
            if (!ctx || ctx.state !== 'running') return;

            const attackerSuccessful = defenseLosses > attackLosses;
            if (attackerSuccessful) {
                playTone(ctx, 560, 0.00, 0.10, 'triangle', 0.065);
                playTone(ctx, 780, 0.10, 0.11, 'triangle', 0.058);
                return;
            }

            playTone(ctx, 250, 0.00, 0.14, 'sawtooth', 0.055, 170);
            playTone(ctx, 160, 0.11, 0.12, 'square', 0.047, 120);
        }

        function isMobileViewport() {
            return window.matchMedia('(max-width: 980px)').matches;
        }

        async function enterImmersiveBattleView() {
            if (!isMobileViewport()) return;
            window.scrollTo(0, 0);
        }

        async function exitImmersiveBattleView() {
            window.scrollTo(0, 0);
        }

        function clampAttackArmies(value) {
            return Math.max(2, Math.min(MAX_ARMIES, value));
        }

        function clampDefenseArmies(value) {
            return Math.max(1, Math.min(MAX_ARMIES, value));
        }

        function adjustSetupArmies(side, step) {
            if (state.battleStarted || state.gameOver || state.isAnimating || state.autoMode) return;

            if (side === 'attack') {
                const nextValue = clampAttackArmies(state.attackArmies + step);
                if (nextValue === state.attackArmies) return;
                state.attackArmies = nextValue;
                elements.attackInput.value = String(nextValue);
            } else {
                const nextValue = clampDefenseArmies(state.defenseArmies + step);
                if (nextValue === state.defenseArmies) return;
                state.defenseArmies = nextValue;
                elements.defenseInput.value = String(nextValue);
            }

            refreshSummary();
            refreshControls();
        }

        function getWheelConfig(type) {
            if (type === 'attack') {
                return {
                    el: elements.attackWheel,
                    picker: elements.attackWheelPicker,
                    min: 2,
                    max: MAX_ARMIES
                };
            }

            return {
                el: elements.defenseWheel,
                picker: elements.defenseWheelPicker,
                min: 1,
                max: MAX_ARMIES
            };
        }

        function highlightWheelItem(type, value) {
            const controller = wheelControllers[type];
            if (!controller) return;
            const items = controller.el.children;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const itemValue = Number(item.dataset.value);
                const distance = Math.abs(itemValue - value);
                item.classList.toggle('active', distance === 0);
                item.classList.toggle('near', distance === 1);
            }
        }

        function updateWheelLayout(type) {
            const controller = wheelControllers[type];
            if (!controller) return;

            const wheelHeight = controller.el.clientHeight;
            if (wheelHeight <= 0) return;
            const sidePadding = Math.max(0, Math.round((wheelHeight - WHEEL_ITEM_HEIGHT) / 2));
            controller.el.style.setProperty('--wheel-edge-padding', `${sidePadding}px`);
        }

        function getWheelTargetTop(controller, value) {
            const index = value - controller.min;
            const item = controller.el.children[index];
            if (!item) {
                return index * WHEEL_ITEM_HEIGHT;
            }

            return item.offsetTop - (controller.el.clientHeight - item.offsetHeight) / 2;
        }

        function getClosestWheelValue(type) {
            const controller = wheelControllers[type];
            if (!controller) return null;

            const centerY = controller.el.scrollTop + controller.el.clientHeight / 2;
            let bestValue = controller.min;
            let bestDistance = Number.POSITIVE_INFINITY;
            const items = controller.el.children;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const itemCenter = item.offsetTop + item.offsetHeight / 2;
                const distance = Math.abs(itemCenter - centerY);
                if (distance < bestDistance) {
                    bestDistance = distance;
                    bestValue = controller.min + i;
                }
            }

            return bestValue;
        }

        function updateAllWheelsLayout() {
            updateWheelLayout('attack');
            updateWheelLayout('defense');
        }

        function setWheelValue(type, value, smooth = false) {
            const controller = wheelControllers[type];
            if (!controller) return;

            const clamped = Math.max(controller.min, Math.min(controller.max, value));
            const targetTop = getWheelTargetTop(controller, clamped);

            if (Math.abs(controller.el.scrollTop - targetTop) > 1) {
                controller.locked = true;
                controller.el.scrollTo({
                    top: targetTop,
                    behavior: smooth ? 'smooth' : 'auto'
                });
                window.setTimeout(() => {
                    controller.locked = false;
                }, smooth ? 220 : 0);
            }

            highlightWheelItem(type, clamped);
        }

        function applyWheelValue(type, value) {
            if (type === 'attack') {
                const nextValue = clampAttackArmies(value);
                if (state.attackArmies === nextValue) return;
                state.attackArmies = nextValue;
                elements.attackInput.value = String(nextValue);
            } else {
                const nextValue = clampDefenseArmies(value);
                if (state.defenseArmies === nextValue) return;
                state.defenseArmies = nextValue;
                elements.defenseInput.value = String(nextValue);
            }

            refreshSummary(true);
            refreshControls();
        }

        function snapWheel(type, smooth = false) {
            const controller = wheelControllers[type];
            if (!controller) return;
            const value = getClosestWheelValue(type);
            if (value === null) return;
            setWheelValue(type, value, smooth);
            applyWheelValue(type, value);
        }

        function initializeWheel(type) {
            const config = getWheelConfig(type);
            const wheel = config.el;
            if (!wheel) return;

            wheel.innerHTML = '';
            for (let value = config.min; value <= config.max; value++) {
                const item = document.createElement('div');
                item.className = 'wheel-item';
                item.dataset.value = String(value);
                item.textContent = String(value);
                wheel.appendChild(item);
            }

            wheelControllers[type] = {
                ...config,
                locked: false,
                scrollRaf: 0,
                snapTimer: 0
            };
            updateWheelLayout(type);

            wheel.addEventListener('scroll', () => {
                const controller = wheelControllers[type];
                if (!controller || controller.locked) return;

                if (controller.scrollRaf) {
                    cancelAnimationFrame(controller.scrollRaf);
                }

                controller.scrollRaf = requestAnimationFrame(() => {
                    const value = getClosestWheelValue(type);
                    if (value === null) return;
                    highlightWheelItem(type, value);
                    applyWheelValue(type, value);
                });

                window.clearTimeout(controller.snapTimer);
                controller.snapTimer = window.setTimeout(() => {
                    snapWheel(type, true);
                }, 90);
            }, { passive: true });

            wheel.addEventListener('click', event => {
                const item = event.target.closest('.wheel-item');
                if (!item) return;
                const value = Number(item.dataset.value);
                setWheelValue(type, value, true);
                applyWheelValue(type, value);
            });
        }

        function initializeWheels() {
            initializeWheel('attack');
            initializeWheel('defense');
            updateAllWheelsLayout();
            setWheelValue('attack', state.attackArmies, false);
            setWheelValue('defense', state.defenseArmies, false);
        }

        function syncWheelsWithState() {
            setWheelValue('attack', state.attackArmies, false);
            setWheelValue('defense', state.defenseArmies, false);
        }

        function rollDice(count) {
            const dice = [];
            for (let i = 0; i < count; i++) {
                dice.push(Math.floor(Math.random() * 6) + 1);
            }
            return dice.sort((a, b) => b - a);
        }

        function simulateBattle(attArmies, defArmies) {
            const attackDiceCount = Math.min(3, attArmies - 1);
            const defenseDiceCount = Math.min(2, defArmies);
            const attackDice = rollDice(attackDiceCount);
            const defenseDice = rollDice(defenseDiceCount);

            let attackLosses = 0;
            let defenseLosses = 0;

            const comparisons = Math.min(attackDice.length, defenseDice.length);
            for (let i = 0; i < comparisons; i++) {
                if (attackDice[i] > defenseDice[i]) {
                    defenseLosses++;
                } else {
                    attackLosses++;
                }
            }

            return {
                attackDice,
                defenseDice,
                attackLosses,
                defenseLosses,
                attArmies: attArmies - attackLosses,
                defArmies: defArmies - defenseLosses
            };
        }

        function createDie(value, side, rolling = false) {
            const die = document.createElement('div');
            die.className = `die ${side}${rolling ? ' rolling' : ''}`;
            die.textContent = String(value);
            return die;
        }

        function renderRollingDice(attackCount, defenseCount) {
            elements.attackTray.innerHTML = '';
            elements.defenseTray.innerHTML = '';

            for (let i = 0; i < attackCount; i++) {
                elements.attackTray.appendChild(createDie('?', 'attack', true));
            }
            for (let i = 0; i < defenseCount; i++) {
                elements.defenseTray.appendChild(createDie('?', 'defense', true));
            }
        }

        function fillDiceValues(diceNodes, values) {
            values.forEach((value, index) => {
                const node = diceNodes[index];
                if (!node) return;
                node.textContent = String(value);
                node.classList.remove('rolling');
            });
        }

        function markDiceOutcome(result, attackNodes, defenseNodes) {
            const comparisons = Math.min(result.attackDice.length, result.defenseDice.length);
            for (let i = 0; i < comparisons; i++) {
                const a = attackNodes[i];
                const d = defenseNodes[i];
                if (!a || !d) continue;
                if (result.attackDice[i] > result.defenseDice[i]) {
                    a.classList.add('win');
                    d.classList.add('lose');
                } else {
                    a.classList.add('lose');
                    d.classList.add('win');
                }
            }
        }

        function pulseElement(el) {
            el.classList.remove('pulse');
            void el.offsetWidth;
            el.classList.add('pulse');
        }

        function setBattleLogOpen(open) {
            const canOpen = isMobileViewport() && state.battleStarted && state.battleLog.length > 0;
            state.logOpen = Boolean(open && canOpen);
            document.body.classList.toggle('log-open', state.logOpen);
            elements.toggleLogBtn.textContent = state.logOpen ? 'Close Log' : 'Battle Log';
            elements.toggleLogBtn.setAttribute('aria-pressed', state.logOpen ? 'true' : 'false');
        }

        function setSupportModalOpen(open) {
            const shouldOpen = Boolean(open);
            document.body.classList.toggle('support-open', shouldOpen);
            elements.supportModal.setAttribute('aria-hidden', shouldOpen ? 'false' : 'true');
            elements.supportFab.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
        }

        function startBattleSession() {
            if (state.isAnimating || state.autoMode) return;

            state.sessionToken += 1;
            state.attackArmies = clampAttackArmies(parseInt(elements.attackInput.value, 10) || 2);
            state.defenseArmies = clampDefenseArmies(parseInt(elements.defenseInput.value, 10) || 1);
            state.battleLog = [];
            state.battleStarted = true;
            state.logOpen = false;
            state.gameOver = false;
            state.autoMode = false;
            state.isAnimating = false;
            state.round = 0;

            elements.attackInput.value = String(state.attackArmies);
            elements.defenseInput.value = String(state.defenseArmies);
            elements.roundAttackLoss.textContent = '0';
            elements.roundDefenseLoss.textContent = '0';
            elements.attackTray.innerHTML = '';
            elements.defenseTray.innerHTML = '';
            document.body.classList.add('battle-mode');
            setBattleLogOpen(false);
            setSupportModalOpen(false);

            refreshSummary();
            refreshBattleLog();
            refreshControls();

            void enterImmersiveBattleView();
        }

        function formatUnitsLabel(value) {
            return `${value} unit${value === 1 ? '' : 's'}`;
        }

        function getVisibleArmyUnitsLimit() {
            if (isMobileViewport() && state.battleStarted) {
                return MOBILE_BATTLE_MAX_UNITS;
            }
            return MAX_ARMY_UNITS;
        }

        function renderArmyFormation(side, armies) {
            const container = side === 'attack' ? elements.attackArmyVisual : elements.defenseArmyVisual;
            const label = side === 'attack' ? elements.attackVisualLabel : elements.defenseVisualLabel;
            const visibleUnits = Math.min(getVisibleArmyUnitsLimit(), armies);
            const hiddenUnits = Math.max(0, armies - visibleUnits);

            label.textContent = formatUnitsLabel(armies);
            container.innerHTML = '';

            const fragment = document.createDocumentFragment();
            for (let i = 0; i < visibleUnits; i++) {
                const unit = document.createElement('div');
                unit.className = `army-unit ${side}`;
                fragment.appendChild(unit);
            }

            if (visibleUnits === 0) {
                const empty = document.createElement('div');
                empty.className = 'army-empty';
                empty.textContent = 'Line Broken';
                fragment.appendChild(empty);
            }

            if (hiddenUnits > 0) {
                const more = document.createElement('div');
                more.className = `army-more ${side}`;
                more.textContent = `+${hiddenUnits}`;
                fragment.appendChild(more);
            }

            container.appendChild(fragment);
        }

        async function animateArmyCasualties(attackLosses, defenseLosses, token = state.sessionToken) {
            const markCasualties = (side, losses) => {
                if (losses <= 0) return;
                const container = side === 'attack' ? elements.attackArmyVisual : elements.defenseArmyVisual;
                const units = [...container.querySelectorAll(`.army-unit.${side}`)];
                const casualtyCount = Math.min(losses, units.length);
                const casualties = side === 'attack'
                    ? units.slice(-casualtyCount)
                    : units.slice(0, casualtyCount);
                casualties.forEach((unit, index) => {
                    unit.style.animationDelay = `${index * 45}ms`;
                    unit.classList.add('casualty');
                });
            };

            markCasualties('attack', attackLosses);
            markCasualties('defense', defenseLosses);

            if (attackLosses > 0 || defenseLosses > 0) {
                await sleep(260);
            }

            return token === state.sessionToken;
        }

        function refreshSummary(skipWheelSync = false) {
            elements.attackInput.value = String(state.attackArmies);
            elements.defenseInput.value = String(state.defenseArmies);
            elements.arenaAttackArmies.textContent = state.attackArmies;
            elements.arenaDefenseArmies.textContent = state.defenseArmies;
            elements.roundNumber.textContent = state.round;
            if (!skipWheelSync) {
                syncWheelsWithState();
            }
            renderArmyFormation('attack', state.attackArmies);
            renderArmyFormation('defense', state.defenseArmies);
        }

        function refreshControls() {
            const canAttack = state.battleStarted && !state.gameOver && !state.isAnimating && state.attackArmies > 1 && state.defenseArmies > 0;
            elements.startBattleBtn.disabled = state.battleStarted || state.isAnimating || state.autoMode;
            elements.attackBtn.disabled = !canAttack || state.autoMode;
            elements.attackToDeathBtn.disabled = !canAttack || state.autoMode;
            elements.toggleLogBtn.disabled = !state.battleStarted || state.battleLog.length === 0;
            elements.attackInput.disabled = state.battleStarted || state.gameOver || state.isAnimating || state.autoMode;
            elements.defenseInput.disabled = state.battleStarted || state.gameOver || state.isAnimating || state.autoMode;
            const setupLocked = state.battleStarted || state.gameOver || state.isAnimating || state.autoMode;
            elements.attackWheelPicker.classList.toggle('disabled', setupLocked);
            elements.defenseWheelPicker.classList.toggle('disabled', setupLocked);
            elements.attackStepper.classList.toggle('disabled', elements.attackInput.disabled);
            elements.defenseStepper.classList.toggle('disabled', elements.defenseInput.disabled);
            stepperButtons.forEach(button => {
                const side = button.dataset.side;
                button.disabled = side === 'attack' ? elements.attackInput.disabled : elements.defenseInput.disabled;
            });

            if (!state.battleStarted || !isMobileViewport()) {
                setBattleLogOpen(false);
            }

            if (!state.battleStarted) {
                elements.statusChip.textContent = 'Ready For Battle';
            } else if (state.gameOver) {
                elements.statusChip.textContent = 'Campaign Complete';
            } else if (state.autoMode) {
                elements.statusChip.textContent = 'Auto-Battle Running';
            } else if (state.isAnimating) {
                elements.statusChip.textContent = 'Resolving Attack';
            } else if (state.attackArmies <= 1 || state.defenseArmies <= 0) {
                elements.statusChip.textContent = 'No More Legal Attacks';
            } else {
                elements.statusChip.textContent = 'Ready For Battle';
            }
        }

        function addBattleLogEntry(entry) {
            const item = document.createElement('li');
            item.className = 'log-item';
            item.innerHTML = `
                <span class="log-round">#${entry.round}</span>
                <div class="log-dice">
                    <div>ATK [${entry.attackDice.join(', ')}]</div>
                    <div>DEF [${entry.defenseDice.join(', ')}]</div>
                </div>
                <div class="log-loss">
                    <div>A-${entry.attackLosses} | D-${entry.defenseLosses}</div>
                    <div>${entry.remainingAttack} vs ${entry.remainingDefense}</div>
                </div>
            `;
            elements.battleLog.prepend(item);
        }

        function refreshBattleLog() {
            if (state.battleLog.length === 0) {
                elements.battleLogPanel.style.display = 'none';
                elements.battleLog.innerHTML = '';
                elements.battleLogTitle.textContent = 'Battle Log';
                setBattleLogOpen(false);
                return;
            }

            elements.battleLogPanel.style.display = 'block';
            const label = state.battleLog.length === 1 ? 'skirmish' : 'skirmishes';
            elements.battleLogTitle.textContent = `Battle Log (${state.battleLog.length} ${label})`;
        }

        function showVictory() {
            state.gameOver = true;
            setBattleLogOpen(false);
        }

        async function animateRound(result, speed) {
            const attackCount = result.attackDice.length;
            const defenseCount = result.defenseDice.length;
            renderRollingDice(attackCount, defenseCount);

            const ticks = speed === 'fast' ? 4 : 7;
            const step = speed === 'fast' ? 55 : 70;

            for (let t = 0; t < ticks; t++) {
                const attackDiceNodes = [...elements.attackTray.children];
                const defenseDiceNodes = [...elements.defenseTray.children];
                attackDiceNodes.forEach(node => {
                    node.textContent = String(Math.floor(Math.random() * 6) + 1);
                });
                defenseDiceNodes.forEach(node => {
                    node.textContent = String(Math.floor(Math.random() * 6) + 1);
                });
                await sleep(step);
            }

            const finalAttackNodes = [...elements.attackTray.children];
            const finalDefenseNodes = [...elements.defenseTray.children];
            fillDiceValues(finalAttackNodes, result.attackDice);
            fillDiceValues(finalDefenseNodes, result.defenseDice);
            markDiceOutcome(result, finalAttackNodes, finalDefenseNodes);

            elements.roundAttackLoss.textContent = result.attackLosses;
            elements.roundDefenseLoss.textContent = result.defenseLosses;
            pulseElement(elements.roundAttackLoss);
            pulseElement(elements.roundDefenseLoss);

            elements.impactFlash.classList.remove('active');
            void elements.impactFlash.offsetWidth;
            elements.impactFlash.classList.add('active');

            elements.battlefield.classList.remove('shake');
            void elements.battlefield.offsetWidth;
            elements.battlefield.classList.add('shake');

            await sleep(speed === 'fast' ? 230 : 400);
        }

        async function executeRound(speed = 'normal', token = state.sessionToken) {
            if (!state.battleStarted || state.attackArmies <= 1 || state.defenseArmies <= 0 || state.isAnimating || state.gameOver) {
                return;
            }

            state.isAnimating = true;
            refreshControls();

            const result = simulateBattle(state.attackArmies, state.defenseArmies);
            await animateRound(result, speed);
            if (token !== state.sessionToken) {
                state.isAnimating = false;
                refreshControls();
                return;
            }

            playAttackOutcomeSound(result.attackLosses, result.defenseLosses);

            const isStillValid = await animateArmyCasualties(result.attackLosses, result.defenseLosses, token);
            if (!isStillValid) {
                state.isAnimating = false;
                refreshControls();
                return;
            }

            state.attackArmies = result.attArmies;
            state.defenseArmies = result.defArmies;
            state.round += 1;

            const logEntry = {
                round: state.round,
                attackDice: result.attackDice,
                defenseDice: result.defenseDice,
                attackLosses: result.attackLosses,
                defenseLosses: result.defenseLosses,
                remainingAttack: state.attackArmies,
                remainingDefense: state.defenseArmies
            };

            state.battleLog.push(logEntry);
            addBattleLogEntry(logEntry);
            refreshBattleLog();
            refreshSummary();
            if (result.attackLosses > 0) {
                pulseElement(elements.arenaAttackArmies);
            }
            if (result.defenseLosses > 0) {
                pulseElement(elements.arenaDefenseArmies);
            }

            if (state.defenseArmies === 0) {
                showVictory();
            } else if (state.attackArmies <= 1) {
                showVictory();
            }

            state.isAnimating = false;
            refreshControls();
        }

        async function executeUntilDeath() {
            if (!state.battleStarted || state.autoMode || state.gameOver) return;

            const runToken = state.sessionToken;
            state.autoMode = true;
            refreshControls();

            while (state.autoMode && runToken === state.sessionToken && state.attackArmies > 1 && state.defenseArmies > 0 && !state.gameOver) {
                await executeRound('fast', runToken);
                await sleep(130);
            }

            if (runToken === state.sessionToken) {
                state.autoMode = false;
            }
            refreshControls();
        }

        function fullReset() {
            state.sessionToken += 1;
            state.attackArmies = 10;
            state.defenseArmies = 10;
            state.battleLog = [];
            state.battleStarted = false;
            state.logOpen = false;
            state.gameOver = false;
            state.autoMode = false;
            state.isAnimating = false;
            state.round = 0;

            elements.roundAttackLoss.textContent = '0';
            elements.roundDefenseLoss.textContent = '0';
            elements.attackTray.innerHTML = '';
            elements.defenseTray.innerHTML = '';
            elements.attackInput.value = '10';
            elements.defenseInput.value = '10';
            document.body.classList.remove('battle-mode');
            setBattleLogOpen(false);
            setSupportModalOpen(false);

            updateAllWheelsLayout();
            refreshSummary();
            refreshBattleLog();
            refreshControls();

            void exitImmersiveBattleView();
        }

        elements.attackBtn.addEventListener('click', async () => {
            unlockAudio();
            await executeRound('normal', state.sessionToken);
        });

        elements.startBattleBtn.addEventListener('click', () => {
            unlockAudio();
            startBattleSession();
        });

        elements.attackToDeathBtn.addEventListener('click', async () => {
            unlockAudio();
            await executeUntilDeath();
        });

        elements.resetBtn.addEventListener('click', () => {
            unlockAudio();
            fullReset();
        });

        elements.toggleLogBtn.addEventListener('click', () => {
            setBattleLogOpen(!state.logOpen);
        });

        elements.supportFab.addEventListener('click', () => {
            setSupportModalOpen(!document.body.classList.contains('support-open'));
        });

        elements.supportModalClose.addEventListener('click', () => {
            setSupportModalOpen(false);
        });

        elements.supportModalBackdrop.addEventListener('click', () => {
            setSupportModalOpen(false);
        });

        const onAttackInputUpdate = event => {
            if (state.battleStarted || state.gameOver || state.isAnimating || state.autoMode) return;
            state.attackArmies = clampAttackArmies(parseInt(event.target.value, 10) || 2);
            event.target.value = String(state.attackArmies);
            refreshSummary();
            refreshControls();
        };

        const onDefenseInputUpdate = event => {
            if (state.battleStarted || state.gameOver || state.isAnimating || state.autoMode) return;
            state.defenseArmies = clampDefenseArmies(parseInt(event.target.value, 10) || 1);
            event.target.value = String(state.defenseArmies);
            refreshSummary();
            refreshControls();
        };

        elements.attackInput.addEventListener('input', onAttackInputUpdate);
        elements.attackInput.addEventListener('change', onAttackInputUpdate);
        elements.defenseInput.addEventListener('input', onDefenseInputUpdate);
        elements.defenseInput.addEventListener('change', onDefenseInputUpdate);

        stepperButtons.forEach(button => {
            button.addEventListener('click', () => {
                const side = button.dataset.side;
                const step = Number(button.dataset.step);
                if (!side || Number.isNaN(step)) return;
                adjustSetupArmies(side, step);
            });
        });

        window.addEventListener('resize', () => {
            setBattleLogOpen(state.logOpen);
            updateAllWheelsLayout();
            refreshSummary();
            refreshControls();
        });

        window.addEventListener('keydown', event => {
            if (event.key === 'Escape' && document.body.classList.contains('support-open')) {
                setSupportModalOpen(false);
            }
        });

        initializeWheels();
        refreshSummary();
        refreshBattleLog();
        refreshControls();

        const unlockAudioOnGesture = () => {
            unlockAudio();
        };
        window.addEventListener('pointerdown', unlockAudioOnGesture, { passive: true });
        window.addEventListener('touchstart', unlockAudioOnGesture, { passive: true });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' }).catch(() => {});
            });
        }
    </script>
</body>
</html>
